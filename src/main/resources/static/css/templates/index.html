<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Task Manager</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" href="/css/style.css">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        .completed { text-decoration: line-through; color: gray; }
        .card { min-width: 250px; position: relative; }
        .completed-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.9rem;
            transform: rotate(-10deg);
        }
    </style>
</head>

<body>

<!-- HEADER -->
<div th:replace="fragments/header :: header"></div>

<!-- ================= WHITE SECTION ================= -->
<div class="container">

    <!-- Flash Message -->
    <div th:if="${success}" class="alert alert-success"
         role="alert" th:text="${success}"></div>

    <!-- Add Task Form -->
    <div class="card mb-4">
        <div class="card-header">
            <h4>Add Task</h4>
        </div>
        <div class="card-body">

            <form action="/add-task" method="post" th:object="${task}">

                <div class="mb-3">
                    <input type="text" th:field="*{title}"
                           placeholder="Title"
                           class="form-control" required>
                </div>

                <div class="mb-3">
                    <input type="text" th:field="*{description}"
                           placeholder="Description"
                           class="form-control" required>
                </div>

                <input type="hidden" th:field="*{startTime}">

                <div class="mb-3">
                    <label>End Time:</label>
                    <input type="datetime-local"
                           th:field="*{endTime}"
                           class="form-control" required>
                </div>

                <div class="mb-3">
                    <select th:field="*{priority}"
                            class="form-select" required>
                        <option value="" disabled selected>Select Priority</option>
                        <option th:value="LOW">Low</option>
                        <option th:value="MEDIUM">Medium</option>
                        <option th:value="HIGH">High</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary">
                    Add Task
                </button>
            </form>

        </div>
    </div>

</div>
<!-- ================= END WHITE SECTION ================= -->


<!-- ================= NETFLIX DARK SECTION ================= -->
<div class="page-bg">

    <!-- Search -->
    <div class="container mb-4">
        <h4 class="text-white">Search Tasks</h4>
        <form action="/search" method="get"
      class="d-flex flex-column flex-md-row gap-2">
            <input type="text"
                   name="keyword"
                   th:value="${keyword}"
                   placeholder="Search by title or description"
                   class="form-control">
            <button type="submit" class="btn btn-secondary">Search</button>
            <a th:href="@{/}" class="btn btn-outline-secondary">Clear</a>
        </form>
    </div>

    <!-- Task List -->
    <div class="container">
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">

            <div class="col" th:each="t : ${tasks}">

                <div class="card h-100 task-item task-card"
                     th:attr="
                        data-endtime=${t.endTime},
                        data-completed=${t.completed}
                     ">

                    <!-- Completed badge -->
                    <span th:if="${t.completed == true}"
                          class="badge bg-success completed-badge">
                        COMPLETED
                    </span>

                    <!-- Clickable card body -->
                    <a th:href="@{/edit-task/{id}(id=${t.id})}"
                       class="task-link">
					<div class="card-body">
                            <h5 class="card-title"
                                th:text="${t.title}"></h5>

                            <p class="card-text"
                               th:text="${t.description}"></p>

                            <span class="badge"
                                  th:text="${t.priority}"></span>

                            <p>Status:
                                <span class="countdown">Calculating...</span>
                            </p>
                        </div>
                    </a>

                    <!-- Card footer -->
                    <div class="card-footer text-end">

                        <form th:if="${t.completed != true}"
                              th:action="@{/toggle-task/{id}(id=${t.id})}"
                              method="post"
                              style="display:inline-block; margin-right:5px;">
                            <button type="submit"
                                    class="btn btn-sm btn-outline-success">
                                Mark as Completed
                            </button>
                        </form>

                        <a th:href="@{/edit-task/{id}(id=${t.id})}"
                           class="btn btn-sm btn-primary">Edit</a>

                        <a th:href="@{/delete-task/{id}(id=${t.id})}"
                           class="btn btn-sm btn-danger"
                           onclick="return confirm('Delete this task?');">
                            Delete
                        </a>
                    </div>

                </div>
            </div>

        </div>
    </div>

</div>
<!-- ================= END NETFLIX SECTION ================= -->


<!-- FOOTER -->
<div th:replace="fragments/footer :: footer"></div>

<!-- ================= COUNTDOWN SCRIPT ================= -->
<script>
document.addEventListener("DOMContentLoaded", function () {

    document.querySelectorAll(".task-item").forEach(task => {

        const isCompleted = task.dataset.completed === "true";
        const countdownEl = task.querySelector(".countdown");

        if (isCompleted) {
            countdownEl.textContent = "Completed";
            countdownEl.style.color = "green";
            return;
        }

        const endTimeStr = task.dataset.endtime;
        if (!endTimeStr) {
            countdownEl.textContent = "No deadline";
            return;
        }

        const endTime = new Date(endTimeStr);

        function update() {
            const now = new Date();
            const diff = endTime - now;

            if (diff <= 0) {
                countdownEl.textContent = "Overdue";
                countdownEl.style.color = "red";
                return;
            }

            const h = Math.floor(diff / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);

            countdownEl.textContent = `${h}h ${m}m ${s}s`;
        }

        update();
        setInterval(update, 1000);
    });
});
</script>

</body>
</html>
